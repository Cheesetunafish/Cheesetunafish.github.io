---
layout: post
title:  "iOS内购了解"
date:   2023-05-11
---

- 如果拥有了自己的app，即使有大佬选择用爱发电，但还有另一种选择就是募集资金；或者当你需要为你的app增加内购功能时，那么这时就需要我们了解iOS的IAP规则。
- 请注意，iOS内购的实现和相关规则可能会随着时间和苹果的更新而有所变化。建议在开发过程中查阅最新的[苹果开发者文档](https://developer.apple.com/cn/documentation/storekit/in-app_purchase/)和相关资源，以确保符合最新的内购规范和实践。

# 概述

iOS内购是指苹果 App Store 的应用内购买，即`In-App Purchase`，简称**IAP**（以下本文关于内购都简称为IAP），是苹果为 App 内购买虚拟商品或服务提供的一套交易系统，允许开发者在**应用程序中**销售额外的内容、功能、订阅或虚拟货币等项目。通过内购系统，应用程序可以与App Store进行交互，让用户可以**直接在应用内购买**相关项目，而无需离开应用程序。

为什么我们需要掌握IAP这套流程呢，因为App Store审核指南规定：

> - 如果您想要在 app 内解锁特性或功能 (解锁方式有：订阅、游戏内货币、游戏关卡、优质内容的访问 限或解锁完整版等)，则必须使用 App 内购买项目。
> - App不得使用自身机制来解锁内容或功能，如许可证密钥、增强现实标记、二维码等。App及其元数据不得包含按钮、外部链接或其他行动号召用语，以指引用户使用非 App 内购买项目机制进行购买。

这段话的大概意思就是APP内的虚拟商品或服务，必须使用 IAP 进行购买支付，不允许使用支付宝、微信支付等其它第三方支付方式（包括Apple Pay），也不允许以任何方式（包括跳出App、提示文案等）引导用户通过应用外部渠道购买。如果违反此规定，apple审核人员**不会让你的APP上架**。

# 内购前准备

APP内集成IAP代码之前需要先去开发账号的**ITunes Connect**进行以下三步操作：

1. 后台填写银行账户信息
2. 配置商品信息，包括产品ID，产品价格等
3. 配置用于测试IAP支付功能的沙箱账户

填写银行账户信息一般交由产品管理人员负责，开发者不需要关注，开发者需要关注的是第二步和第三步。

# 配置内购商品

## 内购类型

IAP 是一套**商品交易系统**，而非简单的支付系统，每一个购买项目都需要在开发者后台的Itunes Connect后台为 App 创建一个对应的商品，提交给苹果审核通过后，购买项目才会生效。内购商品有四种类型：

- **消耗型项目**：只可使用一次的产品，使用之后即失效，必须再次购买，如：游戏币、一次性虚拟道具等
- **非消耗型项目**：只需购买一次，不会过期或随着使用而减少的产品。如：电子书
- **自动续期订阅**：允许用户在固定时间段内购买动态内容的产品。除非用户选择取消，否则此类订阅会自动续期，如：Apple Music这类按月订阅的商品（有些鸡贼的开发者以此收割对IAP商品不熟悉的用户，参考[App Store“流氓”软件](https://link.juejin.cn/?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Fnews%2F609042))
- **非续期订阅**：允许用户购买有时限性服务的产品，此 App 内购买项目的内容可以是静态的。此类订阅不会自动续期

配置商品信息需要注意**产品ID**和**产品价格**

## 产品ID和价格

1. 产品 ID 具有唯一性，建议使用项目的 `Bundle Identidier` 作为前缀，后面拼接自定义的唯一的商品名或者 ID（字母、数字）

> - 这里有个坑：**一旦新建一个内购商品，它的产品ID将永远被占用，即使该商品已经被删除**，已创建的内购商品除了产品 ID 之外的所有信息都可以修改，如果删除了一个内购商品，将无法再创建一个相同产品 ID 的商品，也意味着该产品 ID 永久失效。

1. 在创建IAP项目的时候，需要设定价格，产品价格只能从苹果提供的价格等级去选择，这个价格等级是固定的，同一价格等级会对应各个国家的货币，比如等级1对应1美元、6元人民币，等级2对应2美元、12元人民币……最高等级87对应999.99美元、6498元人民币。另外可能是为了照顾某些货币区的开发者和用户，还有一些特殊的等级，比如备用等级A对应1美元、1元人民币，备用等级B对应1美元、3元人民币这样。除此之外，IAP项目不能定一个9.9元人民币这样不符合任何等级的价格。详细价格等级表可以看苹果的官方价格等级文档。

> - 苹果的价格等级表通常是不会调整的，但也不排除在某些货币汇率发生巨大变化的情况下，对该货币的定价进行调整，调整前苹果会发邮件通知开发者。

1. 商品分成
   1. App Store上的付费App和App内购，苹果与开发者默认是3/7分成。但实际上，在某些地区苹果与开发者分成之前需要先扣除交易税，开发者的实际分成不一定是70%。从2015年10月开始，苹果对中国地区的App Store购买扣除了2%的交易税，对于中国区帐号购买的IAP，开发者的实际分成在68%~69%之间。而且中国以外不同地区的交易税标准也存在差异，如[苹果的官方价格等级文档](https://itunesconnect.apple.com/WebObjects/iTunesConnect.woa/ra/ng/app/880452926/pricingMatrix/subscription)，如果需要严格计算实际收入，可能需要把这个部分也考虑进来。
   2. 针对不同地区的内购，内购价格和对应的开发者实际收入在苹果的价格等级表中有详细列举。
   3. 另外，根据苹果在2016年6月的新规则，针对**Auto-Renewable Subscription**（自动续订）类型的IAP，如果用户购买的订阅时间超过1年，那么从第二年开始，开发者可以获得85%的分成。详情可查看[苹果的订阅产品价格说明](https://developer.apple.com/app-store/subscriptions/)

# 沙盒账户：内购测试

新的内购产品上线之前，测试人员一般需要**对内购产品进行测试**，但是内购涉及到钱，所以苹果为内购测试提供了**沙箱测试账号**的功能，Apple Pay 推出之后**沙箱测试账号**也可以用于 Apple Pay 支付的测试，沙箱测试账号简单理解就是：只能用于内购和 Apple Pay 测试功能的 Apple ID，它并不是真实的 Apple ID。

填写沙箱测试账号信息需要注意以下几点：

- 电子邮件不能是别人已经注册过 AppleID 的邮箱。
- 电子邮箱**可以不是真实**的邮箱，但是必须**符合邮箱格式。**
- App Store 地区的选择，测试的时候弹出的提示框以及结算的价格会按照沙箱账号选择的地区来，建议测试的时候新建几个不同地区的账号进行测试。

沙箱账号测试的**使用**：

- 首先沙箱测试账号必须在真机环境下进行测试，并且是 adhoc 证书或者 develop 证书签名的安装包，沙盒账号不支持直接从 App Store 下载的安装包
- 去真机的 App Store 退出真实的 Apple ID 账号，退出之后并不需要在App Store 里面登录沙箱测试账号
- 然后去 App 里面测试购买商品，会弹出登录框，选择 `使用现有的 Apple ID`，然后登录沙箱测试账号，登录成功之后会弹出购买提示框，点击 `购买`，然后会弹出提示框完成购买。

# 内购流程

IAP的支付流程分为**客户端**和**服务端**

## 客户端

客户端的工作如下：

- 获取内购产品列表（从App内读取或从自己服务器读取），向用户展示内购列表。
- 用户选择某个内购产品后，先请求可用的内购产品的本地化信息列表，此次调用Apple的StoreKit库的代码。
- 得到内购产品的本地化信息后，根据用户选择的内购产品的ID得到内购产品。
- 根据内购产品发起IAP购买请求，收到购买完成的回调。
- 购买流程结束后, 向服务器发起验证凭证以及支付结果的请求。
- 自己的服务器将支付结果信息返回给前端并发放虚拟产品。

## 前端

前端支付流程图如下：

![image-20240302171019804](/Users/aishijie/Library/Application Support/typora-user-images/image-20240302171019804.png)

## 服务端

服务端的工作：

- 接收iOS端发过来的购买凭证，判断凭证是否已经存在或验证过，然后存储该凭证。将该凭证发送到苹果的服务器验证，并将验证结果返回给客户端。

## 恢复购买/丢单处理

### 恢复购买

内购有4种：**消耗型**项目，**非消耗型**，**自动续期订阅**，**非续期订阅**。 

其中**“非消耗型”**和**“自动续期订阅”**需要提供恢复购买的功能，例如创建一个恢复按钮，不然审核很可能会被拒绝。需要调取苹果提供的**内购恢复接口**。

而**“消耗型项目”**和**“非续期订阅”**苹果不会提供恢复的接口。

### 丢单处理

而若发生丢单情况，需要根据IAP的支付流程一项一项分析可能出错环节。

IAP的支付流程：

1. 发起支付
2. 扣费成功
3. 得到receipt（支付凭据）
4. 去后台验证凭据获取商品交易状态
5. 返回数据，验证成功前端刷新数据

漏单情况一：2到3环节出问题属于苹果的问题，目前没做处理。

漏单情况二：3到4的时候出问题，比如断网。此时前端会把支付凭据持久化存储下来，如果期间用户卸载APP此单在前端就真漏了，如果没有协助，下次重新打开app进入购买页会先判断有无未成功的支付，有就提示用户，用户选择找回，重走4，5流程。这一步看产品需求怎么做，可以让用户**自主选择是否恢复未成功的支付**也可以**前端**默默恢复就行。

漏单情况三：4到5的时候出问题。此时后台其实已经成功，只是前端没获取到数据，当漏单处理，下次进入的时候先刷新数据即可。

# 内购注意事项

**交易凭据receipt判重：**

一般来说验证支付凭据(receipt)是否有效**放后台**去做，如果后台不做判重，同一个凭据就可以无数次验证通过，因为**苹果也不判重**，这就会导致前端可以凭此取到的**一个支付凭据**可以**去后台无数次做校验**，后台就会给前端**发放无数次商品**，但是用户只支付了一次钱，所以安全的做法是**后台把验证通过的支付凭据做个记录**，每次**来新的凭据先判断是否已经使用过**，防止多次发放商品。

# StoreKit框架

iOS内购的实现主要依靠苹果提供的StoreKit框架。该框架提供了API和功能，使应用能够与App Store进行交互和处理内购流程。除了StoreKit框架外，还有一些辅助工具和技术可用于简化内购实现，例如StoreKit API的封装库、第三方支付平台的集成等。

> 由于仅仅在此了解一下内购相关知识，所以框架的使用和具体代码就不详细陈述了。细节代码可在github上寻找各种大佬的demo。